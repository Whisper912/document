---
title: 深入理解Java虚拟机笔记(1)-Java内存区域
date: 2019-11-12 09:21:18
tags:
- JVM
categories:
- Java
---


### 运行时内存
如图

* 程序计数器(Program Counter Register)：每个线程都有独立的程序计数器，来记录运行的字节码指令的行号。如果线程执行的是java方法，计数器记录的是正在运行的字节码指令的地址；如果执行的是native方法，计数器值为空(Undifined)。此区域是java虚拟机中唯一一处没有规定OutOfMemoryError异常的区域。

* 虚拟机栈(VM Stack)：可以大致理解为我们通常所说的函数栈。虚拟机栈描述的是Java方法执行时的内存模型，每个方法在执行时都会创建一个栈帧(Stack Frame),用于存储局部变量，操作数栈，动态链接，方法出入口信息。一个方法从调用到执行完成的过程，对应着一个栈帧在虚拟机栈中从入栈到出栈的过程。

* 本地方法栈(Native Method Stack)：与虚拟机栈作用相似，不过本地方法栈是为Native方法服务的。

* Java堆(Java Heap)：几乎所有的**对象**实例都存放在堆空间(说几乎是因为现在的JIT发展和逃逸分析技术等导致了一些变化)。Java堆是垃圾回收的主要区域，从垃圾回收的角度看，Java堆中可以细分为：新生代和老年代。从内存分配的角度看，线程共享的堆中还可能划分出TLAB(Thread Local Allocation Buffer，线程本地分配缓冲区)

* 方法区(Method Area)：存储已经被虚拟机加载的类信息，常亮，静态变量，编译后的代码。JDK8以前，HotSpot虚拟机使用永久代来实现方法区(永久代就等同于方法区)，在永久代上还有常量池。在JDK7时，将静态变量、`字符串常量池`从永久代移动到堆内存上。在JDK8及以后，HotSpot虚拟机将永久代移除，增加了`元空间(MetaSpace)`，元空间存储在本地内存中，当然字符串常量池早已被移到虚拟机堆。

    * 运行时常量池(Runtime Constant Pool)：方法区的一部分。Class文件中除了有类的版本、方法、字段、接口等描述信息外，还有`常量池(Constant Pool Table)`，这个Constant Pool Table存放编译期生成的字面量和符号引用，Constant Pool Table会在类加载后被存放于运行时常量池。

* 直接内存(Direct Memory)：又叫堆外内存，它不是Java虚拟机内存的一部分。Java应用程序执行时会启动一个Java进程，这个进程的用户地址空间可以被分成两份：JVM数据区 + direct memory。

这里有一篇讲解[java8 字符串常量池](https://juejin.im/post/5c9441686fb9a070b153e711)的文章


### 对象的创建
虚拟机遇到一条new指令，如下步骤
1. 检查`常量池`中有无类的符号引用，并检查类是否被加载、解析、初始化过
2. 如果被加载了，为对象分配内存(由于类被加载了，所以能够确定下来需要的内存大小)。
    #### 分配内存
    分配内存的方法有两种
    * 假设内存是规整的，可以采用指针碰撞法，用一个指针将内存分为两部分，左边是使用中的，右边是未使用的，这时分配内存只需要将指针向右移动需要的大小即可。
    * 若内存不规整，使用CMS(concurrent mark sweep)。

    还要考虑线程安全问题，创建对象在虚拟机中是非常频繁的操作，所以仅仅只是修改指针指向这一操作就是非线程安全的。解决这个问题有两种方案。
    * 对分配空间的操作进行同步处理，实际上虚拟机采用的是CAS＋失败重试的方法。
    * 或者为不同线程设立各自的空间，称为本地线程缓冲区(Thread Local Allocation Buffer)。哪个线程要分配内存，就在自己的缓冲区分配，如果TLAB用完，就需要同步锁定
3. 分配完后，虚拟机将分配到的内存空间初始化为0值
4. 接下来，设置对象头(Object Header)，此时，在虚拟机的角度，对象已经创建完成。但从java程序角度看，这才刚刚开始，接下来继续执行init方法，这才算完。

#### 对象内存布局
对象在内存中的存储布局可以分为：对象头(Object Header)+实例数据(Instance Data)+对齐填充(Padding)。

头分为两部分
1. 第一部分存储运行时数据，如哈希码、GC年龄、锁状态、持有的锁、偏向线程ID、偏向时间戳。
2. 第二部分是类型只剩，指向类的元数据的指针。如果对象是个Java数组，还要有一块记录数组长度的数据

实例数据是真正存储的有效信息

对齐填充，HotSpot VM要求对象起始地址必须为8个字节的整数倍。

#### 对象定位访问
Java程序通过栈上的reference来操作堆中的具体对象。有两种访问方式
1. 句柄访问
    reference指向句柄，句柄中有指向堆中对象实例数据的指针，有指向方法区中对象类型数据的指针
2. 直接指针访问
    reference直接指向堆中的对象实例数据，在堆对象中需要考虑如何访问类型数据。